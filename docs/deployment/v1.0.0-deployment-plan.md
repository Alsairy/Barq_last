# BARQ v1.0.0 Production Deployment Plan

This document outlines the complete deployment strategy for BARQ v1.0.0 to production using a safe canary rollout approach.

## Prerequisites

- [x] Docker images built and pushed to registry:
  - `ghcr.io/alsairy/barq-api:v1.0.0`
  - `ghcr.io/alsairy/barq-frontend:v1.0.0`
- [ ] Preview environment successfully deployed and validated
- [ ] All required secrets configured in GitHub environments:
  - `KUBE_CONFIG` - Base64-encoded kubeconfig file
  - `SQL_SA_PASSWORD` - Database connection string
  - `JWT__KEY` - JWT signing key (â‰¥ 256-bit)
  - `JWT__ISSUER`, `JWT__AUDIENCE` - JWT configuration
  - `FILESTORAGE__SIGNINGKEY` - File storage signing key
  - `FLOWABLE__BASEURL` - Workflow engine endpoint

## Deployment Strategy

### 1. Preview Environment Deployment

Before proceeding with production deployment, the preview environment must be successfully deployed and validated:

```bash
# Trigger preview deployment workflow
gh workflow run deploy-preview.yml --repo Alsairy/Barq_last -f tag="v1.0.0"

# Validate preview deployment
./validate-preview-health.sh
```

**Note:** If the preview deployment fails due to KUBE_CONFIG issues, use the manual deployment script:

```bash
# Manual deployment to preview environment
./deploy-preview-manually.sh
```

### 2. Database Migrations

Database migrations must be applied before deploying the new version:

```bash
# Set production connection string
export ConnectionStrings__DefaultConnection="Server=<prod-sql>,1433;Database=BarqProd;User Id=sa;Password=${SQL_SA_PASSWORD};TrustServerCertificate=False;MultipleActiveResultSets=true"

# Apply migrations
cd Backend
dotnet ef database update --project src/BARQ.Infrastructure --startup-project src/BARQ.API
```

### 3. Canary Rollout Strategy

The production deployment follows a phased canary rollout approach:

#### Phase 1: 10% Traffic (30 minutes)

```bash
# Trigger production deployment with 10% canary
./deploy-production-canary.sh v1.0.0 10
```

**Monitoring:**
- Health endpoints: `/health/ready`, `/health/live`, `/health/flowable`, `/health/ai`
- Error rates: < 1% for key endpoints
- P95/P99 latency: Within acceptable thresholds
- Background job processing: Working correctly

#### Phase 2: 50% Traffic (30 minutes)

After successful 10% phase:

```bash
# Increase canary to 50%
./deploy-production-canary.sh v1.0.0 50
```

Continue monitoring the same metrics.

#### Phase 3: 100% Traffic (Full Rollout)

After successful 50% phase:

```bash
# Complete rollout to 100%
./deploy-production-canary.sh v1.0.0 100
```

### 4. Post-Deployment Verification

Run comprehensive smoke and E2E tests against production:

```bash
cd Frontend/barq-frontend
PLAYWRIGHT_BASE_URL="https://barq.tetco.sa" npx playwright test tests/wiring.smoke.spec.ts --reporter=line --workers=1
PLAYWRIGHT_BASE_URL="https://barq.tetco.sa" npx playwright test tests/journeys.e2e.spec.ts --reporter=html --workers=1
```

## Rollback Plan

If issues are detected during any phase of the canary rollout:

1. Immediately revert to the previous version:
   ```bash
   # Rollback to previous version
   ./deploy-production-canary.sh v0.9.0 100
   ```

2. Investigate logs and metrics to identify the root cause.

3. Fix issues and redeploy following the same canary strategy.

## Known Issues and Mitigations

1. **KUBE_CONFIG Secret Issues**
   - **Issue:** The KUBE_CONFIG secret may be improperly encoded or formatted.
   - **Mitigation:** Use the minimal kubeconfig approach or manual deployment if needed.

2. **Database Connection**
   - **Issue:** Connection string format in appsettings.json doesn't support environment variable interpolation.
   - **Mitigation:** Set the full connection string via environment variables.

3. **JWT Token Generation**
   - **Issue:** JWT key length and claims need to be properly configured.
   - **Mitigation:** Ensure JWT__KEY is at least 256 bits (32 bytes) and properly encoded.

## Verification Checklist

- [ ] Preview deployment successful
- [ ] Database migrations applied successfully
- [ ] 10% canary deployment healthy for 30 minutes
- [ ] 50% canary deployment healthy for 30 minutes
- [ ] 100% rollout successful
- [ ] Smoke tests pass
- [ ] E2E tests pass
- [ ] No errors in application logs
- [ ] Background jobs processing correctly
- [ ] File uploads and downloads working
- [ ] User authentication and authorization working
